rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper to check if user is accessing their own data
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper to check if user is an admin (assuming custom claim or role field check if relying on doc)
    // For now, we rely on checking the user document, but ideally use custom claims.
    // Reading user doc in rules costs read quota.
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // USERS
    match /users/{userId} {
      allow read: if isAuthenticated(); // Allow reading profiles (might restrict sensitive fields)
      allow create: if isAuthenticated() && isOwner(userId); // Users sign up themselves
      allow update: if isAuthenticated() && isOwner(userId); // Users update own profile
      allow delete: if false; // Only soft delete or admin
    }
    
    // TRIPS
    match /trips/{tripId} {
      allow read: if true; // Public can see trips
      // Organizers can create/update their own trips
      allow create: if isAuthenticated(); 
      allow update: if isAuthenticated() && (resource.data.organizer.id == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }
    
    // BOOKINGS
    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && (resource.data.travelerId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated(); // Users book trips
      allow update: if isAdmin(); // Only admins/system verify bookings
    }
    
    // ORGANIZERS
    match /organizers/{organizerId} {
      allow read: if true;
      allow write: if isAdmin(); // Onboarding is via admin/api usually, or strict rules
    }
    
    // WALLET TRANSACTIONS
    match /wallet_transactions/{txId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false; // ONLY Server-Side (Admin SDK) can write to wallet
    }
  }
}
